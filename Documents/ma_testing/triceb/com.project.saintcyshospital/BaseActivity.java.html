<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">com.project.saintcyshospital</a> &gt; <span class="el_source">BaseActivity.java</span></div><h1>BaseActivity.java</h1><pre class="source lang-java linenums">package com.project.saintcyshospital;

import android.content.Intent;
import android.view.Menu;
import android.view.MenuItem;
import android.widget.Toast;

import androidx.activity.OnBackPressedCallback;
import androidx.appcompat.app.AppCompatActivity;

import com.google.android.material.bottomnavigation.BottomNavigationView;
import com.project.saintcyshospital.ws.WsHub;

/**
 * Base activity for all screens that use the bottom navigation, auth guard, and
 * shared behaviors (token refresh handling, global notification websocket, etc.).
 *
 * &lt;p&gt;Derive your activity from this class and call {@link #setupBottomNav(int)} in
 * {@code onCreate()} after {@code setContentView(...)}.&lt;/p&gt;
 *  * @author Trice Buchanan
 */
<span class="fc" id="L22">public class BaseActivity extends AppCompatActivity {</span>

    /**
     * Process-wide flag indicating whether this process has already prompted
     * the user for the Android 13+ notification permission. Prevents repeated
     * permission dialogs as activities are started and stopped.
     */
<span class="fc" id="L29">    private static boolean sAskedNotifPerm = false;</span>

    /**
     * Tracks whether a failed request has already been retried after a token
     * refresh attempt. Used by {@link #handleVolleyAuthError(com.android.volley.VolleyError, Runnable)}
     * to ensure only a single retry per failing request.
     */
<span class="fc" id="L36">    protected boolean retriedAfterRefresh = false;</span>

    /**
     * Whether this activity requires an authenticated user. If {@code true},
     * {@link #onStart()} will redirect to {@link HomeActivity} when the user is not logged in.
     * Override and return {@code false} for public screens (e.g., Login, Signup).
     */
    protected boolean requiresAuth() {
<span class="nc" id="L44">        return true;</span>
    }

    /**
     * Reference to the slide-over &quot;More&quot; menu layout shown from the bottom
     * navigation bar. May be {@code null} on screens that do not include it.
     */
    private MoreMenuLayout moreMenu;
    /**
     * Back-press callback that first closes the &quot;More&quot; menu if it is open,
     * and otherwise defers to the default back navigation. Registered in
     * {@link #setupBottomNav(int)} when the menu is present.
     */
    private OnBackPressedCallback moreMenuBackCallback;

    /**
     * Starts the global notification websocket if the user is logged in,
     * checks (and optionally requests) notification permission (Android 13+),
     * and enforces the {@link #requiresAuth()} gate.
     */
    @Override
    protected void onStart() {
<span class="fc" id="L66">        super.onStart();</span>

<span class="pc bpc" id="L68" title="3 of 4 branches missed.">        if (requiresAuth() &amp;&amp; !AuthManager.isLoggedIn(getApplicationContext())) {</span>
<span class="nc" id="L69">            Intent i = new Intent(this, HomeActivity.class);</span>
<span class="nc" id="L70">            i.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP</span>
                    | Intent.FLAG_ACTIVITY_NEW_TASK
                    | Intent.FLAG_ACTIVITY_CLEAR_TASK);
<span class="nc" id="L73">            startActivity(i);</span>
<span class="nc" id="L74">            finish();</span>
<span class="nc" id="L75">            return;</span>
        }

<span class="pc bpc" id="L78" title="1 of 4 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 33 &amp;&amp; !sAskedNotifPerm) {</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            if (checkSelfPermission(android.Manifest.permission.POST_NOTIFICATIONS)</span>
                    != android.content.pm.PackageManager.PERMISSION_GRANTED) {
<span class="fc" id="L81">                requestPermissions(</span>
                        new String[]{android.Manifest.permission.POST_NOTIFICATIONS},
                        4242
                );
            }
<span class="fc" id="L86">            sAskedNotifPerm = true;</span>
        }

<span class="pc bpc" id="L89" title="1 of 2 branches missed.">        if (AuthManager.isLoggedIn(getApplicationContext())) {</span>
<span class="nc" id="L90">            WsHub.get().start(getApplicationContext());</span>
        }
<span class="fc" id="L92">    }</span>


    /**
     * Decrements the websocket reference count and disconnects it when
     * no screens are visible (app background), minimizing reconnection churn.
     */
    @Override
    protected void onStop() {
<span class="fc" id="L101">        super.onStop();</span>
<span class="fc" id="L102">    }</span>

    /**
     * Suppresses the legacy toolbar menu for screens that use the bottom navigation
     * and the slide-over “More” panel. Returning {@code false} prevents the menu
     * from being shown.
     *
     * @param menu ignored
     * @return {@code false} to indicate no options menu is provided
     */
    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L114">        return false;</span>
    }

    /**
     * Handler because this base class delegates navigation to the bottom
     * nav and the “More” panel. Subclasses that actually inflate an options menu
     * can override this method and call {@code super} as needed.
     *
     * @param item the selected menu item
     * @return {@code super.onOptionsItemSelected(item)} by default
     */
    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc" id="L127">        return super.onOptionsItemSelected(item);</span>
    }

    /**
     * Standard toolbar helper for activities that still use an app bar.
     * Safe to call even when the layout omits a toolbar.
     *
     * @param toolbarId the resource id of the Toolbar in the layout
     */
    protected void wireToolbar(int toolbarId) {
<span class="nc" id="L137">        androidx.appcompat.widget.Toolbar tb = findViewById(toolbarId);</span>
<span class="nc" id="L138">        setSupportActionBar(tb);</span>
<span class="nc" id="L139">    }</span>

    /**
     * Wires the bottom navigation and the custom &quot;More&quot; slide-over menu.
     * Handles role-based visibility and navigation without recreating animations.
     *
     * @param selectedItemId the id of the nav item that should appear selected in this screen
     */
    protected void setupBottomNav(int selectedItemId) {
<span class="nc" id="L148">        BottomNavigationView nav = findViewById(R.id.bottomNav);</span>
<span class="nc" id="L149">        moreMenu = findViewById(R.id.moreMenu);</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (moreMenu != null) {</span>
<span class="nc" id="L152">            String role = AuthManager.getRole(getApplicationContext());</span>
<span class="nc" id="L153">            moreMenu.configureForRole(role);</span>
<span class="nc" id="L154">            moreMenu.setListener(new MoreMenuLayout.Listener() {</span>
                /**
                 * Invoked when the user selects the notifications entry in the
                 * &quot;More&quot; menu. Opens {@link NotificationsActivity}.
                 */
                @Override public void onNotifications() {
<span class="nc" id="L160">                    startActivity(new Intent(BaseActivity.this, NotificationsActivity.class));</span>
<span class="nc" id="L161">                }</span>

                /**
                 * Invoked when the user selects the histories entry. For users
                 * with a doctor role, opens {@link HistoriesActivity}; ignored
                 * for other roles.
                 */
                @Override public void onHistories() {
<span class="nc bnc" id="L169" title="All 2 branches missed.">                    if (AuthManager.isDoctor(getApplicationContext())) {</span>
<span class="nc" id="L170">                        startActivity(new Intent(BaseActivity.this, HistoriesActivity.class));</span>
                    }
<span class="nc" id="L172">                }</span>

                /**
                 * Invoked when the admin entry is selected in the &quot;More&quot; menu.
                 * Opens {@link AdminActivity} for users with an admin role.
                 */
                @Override public void onAdmin() {
<span class="nc bnc" id="L179" title="All 2 branches missed.">                    if (AuthManager.isAdmin(getApplicationContext())) {</span>
<span class="nc" id="L180">                        startActivity(new Intent(BaseActivity.this, AdminActivity.class));</span>
                    }
<span class="nc" id="L182">                }</span>

                /**
                 * Invoked when the pharmacist entry is selected. For users
                 * with a pharmacist role, opens {@link PharmacistActivity}.
                 */
                @Override public void onPharmacist() {
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    if (AuthManager.isPharmacist(getApplicationContext())) {</span>
<span class="nc" id="L190">                        startActivity(new Intent(BaseActivity.this, PharmacistActivity.class));</span>
                    }
<span class="nc" id="L192">                }</span>

                /**
                 * Invoked when the doctor prescriptions entry is selected.
                 * For doctor users, opens {@link DoctorPrescriptionsActivity}.
                 */
                @Override public void onDoctorPrescriptions() {
<span class="nc bnc" id="L199" title="All 2 branches missed.">                    if (AuthManager.isDoctor(getApplicationContext())) {</span>
<span class="nc" id="L200">                        startActivity(new Intent(BaseActivity.this, DoctorPrescriptionsActivity.class));</span>
                    }
<span class="nc" id="L202">                }</span>

                /**
                 * Invoked when the settings entry is selected in the &quot;More&quot;
                 * menu. Opens {@link SettingsActivity}.
                 */
                @Override public void onSettings() {
<span class="nc" id="L209">                    startActivity(new Intent(BaseActivity.this, SettingsActivity.class));</span>
<span class="nc" id="L210">                }</span>

                /**
                 * Invoked when the logout entry is selected. Closes the menu,
                 * stops global websocket connections, clears auth state, shows
                 * a confirmation toast, and returns the user to {@link HomeActivity}.
                 */
                @Override public void onLogout() {
<span class="nc" id="L218">                    moreMenu.close();</span>

<span class="nc" id="L220">                    WsHub.get().stop();</span>
<span class="nc" id="L221">                    AuthManager.clear(getApplicationContext());</span>
<span class="nc" id="L222">                    Toast.makeText(getApplicationContext(),</span>
<span class="nc" id="L223">                            &quot;You have been logged out.&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L224">                    Intent i = new Intent(BaseActivity.this, HomeActivity.class);</span>
<span class="nc" id="L225">                    i.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);</span>
<span class="nc" id="L226">                    startActivity(i);</span>
<span class="nc" id="L227">                    finish();</span>
<span class="nc" id="L228">                }</span>
            });

<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (moreMenuBackCallback == null) {</span>
<span class="nc" id="L232">                moreMenuBackCallback = new OnBackPressedCallback(true) {</span>
                    /**
                     * Handles system back presses while this activity is visible.
                     * If the &quot;More&quot; menu is open, it is closed; otherwise the
                     * callback disables itself and delegates to the default
                     * back-press dispatcher.
                     */
                    @Override
                    public void handleOnBackPressed() {
<span class="nc bnc" id="L241" title="All 4 branches missed.">                        if (moreMenu != null &amp;&amp; moreMenu.isOpen()) {</span>
<span class="nc" id="L242">                            moreMenu.close();</span>
                        } else {
<span class="nc" id="L244">                            setEnabled(false);</span>
<span class="nc" id="L245">                            getOnBackPressedDispatcher().onBackPressed();</span>
                        }
<span class="nc" id="L247">                    }</span>
                };
<span class="nc" id="L249">                getOnBackPressedDispatcher().addCallback(this, moreMenuBackCallback);</span>
            }
        }

<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (nav == null) return;</span>

<span class="nc" id="L255">        nav.setOnItemSelectedListener(item -&gt; {</span>
<span class="nc" id="L256">            int id = item.getItemId();</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (id == R.id.nav_more) {</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                if (moreMenu != null) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                    if (!moreMenu.isOpen()) moreMenu.open();</span>
<span class="nc" id="L261">                    else moreMenu.close();</span>
                }
<span class="nc" id="L263">                return false;</span>
            }

<span class="nc bnc" id="L266" title="All 4 branches missed.">            if (moreMenu != null &amp;&amp; moreMenu.isOpen()) {</span>
<span class="nc" id="L267">                moreMenu.close();</span>
            }

<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (id == selectedItemId) return true;</span>

<span class="nc" id="L272">            Intent intent = null;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (id == R.id.nav_home) {</span>
<span class="nc" id="L274">                intent = new Intent(this, HomeActivity.class);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            } else if (id == R.id.nav_pharmacy) {</span>
<span class="nc" id="L276">                intent = new Intent(this, PharmacyActivity.class);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            } else if (id == R.id.nav_messages) {</span>
<span class="nc" id="L278">                intent = new Intent(this, MessagesActivity.class);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            } else if (id == R.id.nav_appointments) {</span>
<span class="nc" id="L280">                intent = new Intent(this, AppointmentsActivity.class);</span>
            }

<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (intent != null) {</span>
<span class="nc" id="L284">                intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span>
<span class="nc" id="L285">                startActivity(intent);</span>
<span class="nc" id="L286">                overridePendingTransition(0, 0);</span>
<span class="nc" id="L287">                return true;</span>
            }
<span class="nc" id="L289">            return false;</span>
        });

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (selectedItemId != 0) {</span>
<span class="nc" id="L293">            nav.setSelectedItemId(selectedItemId);</span>
        }
<span class="nc" id="L295">    }</span>

    /**
     * Centralized Volley 401 handling. Attempts a single token refresh; if refresh fails,
     * clears auth state and navigates to {@link LoginActivity}.
     *
     * @param error the Volley error received from a request
     * @param retry a {@link Runnable} to execute if refresh succeeds
     */
    protected void handleVolleyAuthError(com.android.volley.VolleyError error, Runnable retry) {
<span class="nc bnc" id="L305" title="All 2 branches missed.">        int code = (error.networkResponse != null) ? error.networkResponse.statusCode : -1;</span>

<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (code == 401) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (retriedAfterRefresh) {</span>
<span class="nc" id="L309">                retriedAfterRefresh = false;</span>
<span class="nc" id="L310">                WsHub.get().stop();</span>
<span class="nc" id="L311">                AuthManager.clear(getApplicationContext());</span>
<span class="nc" id="L312">                Toast.makeText(getApplicationContext(),</span>
<span class="nc" id="L313">                        &quot;Session expired. Please log in again.&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L314">                startActivity(new Intent(BaseActivity.this, LoginActivity.class));</span>
<span class="nc" id="L315">                finish();</span>
<span class="nc" id="L316">                return;</span>
            }
<span class="nc" id="L318">            retriedAfterRefresh = true;</span>
<span class="nc" id="L319">            TokenRefresher.refresh(getApplicationContext(), new TokenRefresher.Callback() {</span>
                /**
                 * Called when the access token has been successfully refreshed.
                 * If the activity is still running, the original request is
                 * retried via the supplied {@code retry} runnable.
                 */
                @Override public void onRefreshed() {
<span class="nc bnc" id="L326" title="All 2 branches missed.">                    if (!isFinishing()) retry.run();</span>
<span class="nc" id="L327">                }</span>
                /**
                 * Called when token refresh fails. Clears any saved auth state,
                 * stops websocket connections, notifies the user, and navigates
                 * to {@link LoginActivity} to force a new sign-in.
                 */
                @Override public void onFailed() {
<span class="nc" id="L334">                    retriedAfterRefresh = false;</span>
<span class="nc" id="L335">                    WsHub.get().stop();</span>
<span class="nc" id="L336">                    AuthManager.clear(getApplicationContext());</span>
<span class="nc" id="L337">                    Toast.makeText(getApplicationContext(),</span>
<span class="nc" id="L338">                            &quot;Session expired. Please log in again.&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L339">                    startActivity(new Intent(BaseActivity.this, LoginActivity.class));</span>
<span class="nc" id="L340">                    finish();</span>
<span class="nc" id="L341">                }</span>
            });
<span class="nc" id="L343">            return;</span>
        }

<span class="nc" id="L346">        retriedAfterRefresh = false;</span>
<span class="nc" id="L347">        Toast.makeText(getApplicationContext(),</span>
<span class="nc" id="L348">                &quot;Request failed (&quot; + code + &quot;)&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L349">    }</span>

    /**
     * Convenience toast helper used across subclasses.
     *
     * @param s the message to display as a long toast
     */
    void toast(String s) {
<span class="nc" id="L357">        Toast.makeText(getApplicationContext(), s, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L358">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>Generated by the Android Gradle plugin 8.13.0</div></body></html>